syntax = "proto3";

package apito.plugin.v1;

option go_package = "./protobuff";

import "google/protobuf/any.proto";
import "google/protobuf/struct.proto";

// Universal Plugin service - everything is done through schema/API registration
// This service can handle any type of plugin: storage, CDN, auth, logic, etc.
service PluginService {
  // Initialize the plugin with environment variables
  rpc Init(InitRequest) returns (InitResponse);
  
  // Run plugin migration
  rpc Migration(MigrationRequest) returns (MigrationResponse);
  
  // Register GraphQL schema
  rpc SchemaRegister(SchemaRegisterRequest) returns (SchemaRegisterResponse);
  
  // Register REST API endpoints
  rpc RESTApiRegister(RESTApiRegisterRequest) returns (RESTApiRegisterResponse);
  
  // Get plugin version
  rpc GetVersion(GetVersionRequest) returns (GetVersionResponse);
  
  // Execute a function/resolver in the plugin
  rpc Execute(ExecuteRequest) returns (ExecuteResponse);
}

// Host service that provides operations to plugins (bidirectional communication)
service HostService {
  // Generate tenant token
  rpc GenerateTenantToken(GenerateTenantTokenRequest) returns (GenerateTenantTokenResponse);
  
  // Get project details
  rpc GetProjectDetails(GetProjectDetailsRequest) returns (GetProjectDetailsResponse);
  
  // Get single resource
  rpc GetSingleResource(GetSingleResourceRequest) returns (GetSingleResourceResponse);
  
  // Search resources
  rpc SearchResources(SearchResourcesRequest) returns (SearchResourcesResponse);
  
  // Get relation documents
  rpc GetRelationDocuments(GetRelationDocumentsRequest) returns (GetRelationDocumentsResponse);
  
  // Create new resource
  rpc CreateNewResource(CreateNewResourceRequest) returns (CreateNewResourceResponse);
  
  // Update resource
  rpc UpdateResource(UpdateResourceRequest) returns (UpdateResourceResponse);
  
  // Delete resource
  rpc DeleteResource(DeleteResourceRequest) returns (DeleteResourceResponse);
  
  // Debug
  rpc Debug(DebugRequest) returns (DebugResponse);
}

// Common types
message EnvVariable {
  string key = 1; // @inject_tag: yaml:"key"
  string value = 2; // @inject_tag: yaml:"value"
  bool hide = 3; // @inject_tag: yaml:"hide"
  bool is_system = 4; // @inject_tag: yaml:"is_system"
}

// Plugin load status
enum PluginLoadStatus {
  PLUGIN_LOAD_STATUS_NOT_INSTALLED = 0;
  PLUGIN_LOAD_STATUS_INSTALLED = 1;
  PLUGIN_LOAD_STATUS_REINSTALL = 2;
  PLUGIN_LOAD_STATUS_LOADING = 3;
  PLUGIN_LOAD_STATUS_LOADED = 4;
  PLUGIN_LOAD_STATUS_LOAD_FAILED = 5;
}

// Plugin activate status
enum PluginActivateStatus {
  PLUGIN_ACTIVATE_STATUS_DEACTIVATED = 0;
  PLUGIN_ACTIVATE_STATUS_ACTIVATED = 1;
}

// HashiCorp handshake configuration
message HashiCorpHandshakeConfig {
  uint32 protocol_version = 1; // @inject_tag: yaml:"protocol_version"
  string magic_cookie_key = 2; // @inject_tag: yaml:"magic_cookie_key"
  string magic_cookie_value = 3; // @inject_tag: yaml:"magic_cookie_value"
}

// Plugin details message
message PluginDetails {
  string id = 1; // @inject_tag: yaml:"id"
  string title = 2; // @inject_tag: yaml:"title"
  string icon = 3; // @inject_tag: yaml:"icon"
  int64 serial = 4; // @inject_tag: yaml:"serial"
  string version = 5; // @inject_tag: yaml:"version"
  string description = 6; // @inject_tag: yaml:"description"
  repeated string tags = 7; // @inject_tag: yaml:"tags"
  repeated EnvVariable env_vars = 8; // @inject_tag: yaml:"env_vars"
  string exported_variable = 9; // @inject_tag: yaml:"exported_variable"
  bool enable = 10; // @inject_tag: yaml:"enable"
  bool debug = 11; // @inject_tag: yaml:"debug"
  string repository_url = 12; // @inject_tag: yaml:"repository_url"
  string branch = 13; // @inject_tag: yaml:"branch"
  string author = 14; // @inject_tag: yaml:"author"
  PluginLoadStatus load_status = 15; // @inject_tag: yaml:"load_status"
  PluginActivateStatus activate_status = 16; // @inject_tag: yaml:"activate_status"
  repeated string enable_for_projects = 17; // @inject_tag: yaml:"enable_for_projects"
  string language = 18; // @inject_tag: yaml:"language" // "go", "js", "python", etc.
  PluginUIConfig ui_config = 19; // @inject_tag: yaml:"ui_config"
  repeated string registered_graphql_schemas = 20; // @inject_tag: yaml:"registered_graphql_schemas"
  repeated string registered_rest_apis = 21; // @inject_tag: yaml:"registered_rest_apis"
  GraphQLSchemaConfig graphql_schema_config = 22; // @inject_tag: yaml:"graphql_schema_config"
  repeated RESTApiConfigItem rest_api_config = 23; // @inject_tag: yaml:"rest_api_config"
  // HashiCorp specific fields
  string binary_path = 24; // @inject_tag: yaml:"binary_path"
  HashiCorpHandshakeConfig handshake_config = 25; // @inject_tag: yaml:"handshake_config"
}

message GraphQLSchemaConfig {
  repeated GraphQLSchemaConfigItem queries = 1; // @inject_tag: yaml:"queries"
  repeated GraphQLSchemaConfigItem mutations = 2; // @inject_tag: yaml:"mutations"
  repeated GraphQLSchemaConfigItem subscriptions = 3; // @inject_tag: yaml:"subscriptions"
}

message GraphQLSchemaConfigItem {
  string name = 1; // @inject_tag: yaml:"name"
  string placement = 2; // @inject_tag: yaml:"placement" // "internal" or "external"
}

message RESTApiConfigItem {
  string route = 1; // @inject_tag: yaml:"route"
  string placement = 2; // @inject_tag: yaml:"placement" // "internal" or "external"
}

message RESTApi {
  string route = 1;
  string method = 2;
  string description = 3;
  google.protobuf.Struct schema = 4;
}

message PluginUIConfig {
  bool enable = 1; // @inject_tag: yaml:"enable"
  string dist_path = 2; // @inject_tag: yaml:"dist_path"
  PluginUIIntegration integration = 3; // @inject_tag: yaml:"integration"
  repeated PluginUISettings settings = 4; // @inject_tag: yaml:"settings"
}

message PluginUIIntegration {
  PluginUIMenu header_menu = 1;
  repeated PluginUIRoute routes = 2;
}

message PluginUIRoute {
  string path = 1;
  string component = 2;
  string title = 3;
}

message PluginUISettings {
  PluginUIMenu menu = 1;
  string section = 2;
}

message PluginUIMenu {
  string label = 1;
  string path = 2;
  string position = 3;
  string icon = 4;
}


// Note: PluginLanguage is now a string field in PluginDetails
// Supported values: "go", "js", "cpp", "python", "java", "ruby", "php", "csharp", "typescript", "rust", "lua", "dart"

message ThirdPartyGraphQLSchemas {
  google.protobuf.Struct queries = 1;
  google.protobuf.Struct mutations = 2;
  google.protobuf.Struct subscriptions = 3;
}

message ThirdPartyRESTApi {
  string method = 1;
  string path = 2;
  string description = 3;
  google.protobuf.Struct schema = 4;
  // Optional: handler function name for this endpoint
  string handler = 5;
}

message PluginProject {
  string id = 1;
  string name = 2;
  string description = 3;
  google.protobuf.Struct schema = 4;
  string created_at = 5;
  string updated_at = 6;
}

message AuditData {
  string resource = 1;
  string action = 2;
  google.protobuf.Struct author = 3;
  google.protobuf.Struct data = 4;
  google.protobuf.Struct meta = 5;
  google.protobuf.Struct additional_fields = 6;
}

// Plugin Service Messages
message InitRequest {
  repeated EnvVariable env_vars = 1;
}

message InitResponse {
  bool success = 1;
  string message = 2;
}

message MigrationRequest {}

message MigrationResponse {
  bool success = 1;
  string message = 2;
}

message SchemaRegisterRequest {}

message SchemaRegisterResponse {
  ThirdPartyGraphQLSchemas schema = 1;
}

message RESTApiRegisterRequest {}

message RESTApiRegisterResponse {
  repeated ThirdPartyRESTApi apis = 1;
}

message GetVersionRequest {}

message GetVersionResponse {
  string version = 1;
}

message ExecuteRequest {
  string function_name = 1;    // The function/resolver name to execute
  string function_type = 2;    // Type: "graphql_query", "graphql_mutation", "rest_api", "function"
  google.protobuf.Struct args = 3;  // Arguments for the function
  google.protobuf.Struct context = 4;  // Additional context data
}

message ExecuteResponse {
  bool success = 1;
  string message = 2;
  google.protobuf.Any result = 3;  // The actual result data
}

// Host Service Messages
message GenerateTenantTokenRequest {
  string token = 1;
  string tenant_id = 2;
}

message GenerateTenantTokenResponse {
  string token = 1;
}

message GetProjectDetailsRequest {
  string project_id = 1;
}

message GetProjectDetailsResponse {
  PluginProject project = 1;
}

message GetSingleResourceRequest {
  string model = 1;
  string id = 2;
  bool single_page_data = 3;
}

message GetSingleResourceResponse {
  google.protobuf.Any resource = 1;
}

message SearchResourcesRequest {
  string model = 1;
  google.protobuf.Struct filter = 2;
  bool aggregate = 3;
}

message SearchResourcesResponse {
  google.protobuf.Any resources = 1;
}

message GetRelationDocumentsRequest {
  string id = 1;
  google.protobuf.Struct connection = 2;
}

message GetRelationDocumentsResponse {
  google.protobuf.Any documents = 1;
}

message CreateNewResourceRequest {
  string model = 1;
  google.protobuf.Struct data = 2;
  google.protobuf.Struct connection = 3;
}

message CreateNewResourceResponse {
  google.protobuf.Any resource = 1;
}

message UpdateResourceRequest {
  string model = 1;
  string id = 2;
  bool single_page_data = 3;
  google.protobuf.Struct data = 4;
  google.protobuf.Struct connect = 5;
  google.protobuf.Struct disconnect = 6;
}

message UpdateResourceResponse {
  google.protobuf.Any resource = 1;
}

message DeleteResourceRequest {
  string model = 1;
  string id = 2;
}

message DeleteResourceResponse {
  bool success = 1;
  string message = 2;
}

message DebugRequest {
  string stage = 1;
  repeated google.protobuf.Any data = 2;
}

message DebugResponse {
  google.protobuf.Any result = 1;
} 